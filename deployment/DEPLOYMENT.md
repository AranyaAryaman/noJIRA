# NOJIRA Production Deployment Guide

## Overview

Deploy NOJIRA to EC2 at `ops.hushtalent.io` using Docker Compose.

**Stack:**
- Frontend: nginx container (serves React build + proxies to backend)
- Backend: FastAPI container (port 8007)
- Database: PostgreSQL 15 container (port 5433)

**Cost:** ~$1/month (small EBS volume only, using existing EC2)

---

## Quick Start

### 1. SSH to EC2

```bash
ssh ec2-user@<ec2-ip>
```

### 2. Prepare Directory

```bash
sudo mkdir -p /opt/nojira
sudo chown ec2-user:ec2-user /opt/nojira
cd /opt/nojira
```

### 3. Clone Repository

```bash
git clone <NOJIRA_REPO_URL> .
```

### 4. Run Deployment

```bash
chmod +x deploy-ec2.sh
./deploy-ec2.sh deploy
```

The script will:
- ✅ Check Docker/Docker Compose installed
- ✅ Generate secure secrets (SECRET_KEY, DB_PASSWORD)
- ✅ Create .env file with production config
- ✅ Create data directories (postgres, uploads, backups)
- ✅ Build Docker images
- ✅ Start all containers
- ✅ Wait for health checks
- ✅ Test endpoints

### 5. Setup Automation (Optional)

```bash
# Automated daily backups (3 AM)
./setup-backups.sh

# Container monitoring (every 5 min)
./setup-monitoring.sh

# Auto-start on EC2 reboot
./setup-systemd.sh
```

---

## Configuration

### Environment Variables

Production environment is configured in `.env` (auto-generated):

```bash
# Database
POSTGRES_USER=nojira_user
POSTGRES_PASSWORD=<auto-generated-32-chars>
POSTGRES_DB=nojira

# Backend
SECRET_KEY=<auto-generated-64-chars>
ENVIRONMENT=production
ALLOWED_ORIGINS=https://ops.hushtalent.io

# Frontend
VITE_API_BASE_URL=https://ops.hushtalent.io
```

### Port Allocation

| Port | Service | Access |
|------|---------|--------|
| 80 | frontend (nginx) | ALB only |
| 8007 | backend (FastAPI) | localhost only |
| 5433 | PostgreSQL | localhost only |

---

## AWS Configuration

### 1. ALB Configuration

Add listener rule for `ops.hushtalent.io`:

**Via AWS Console:**
1. EC2 → Load Balancers → Select your ALB
2. Listeners → HTTPS:443 → View/edit rules
3. Add rule:
   - **IF:** Host header = `ops.hushtalent.io`
   - **THEN:** Forward to target group

### 2. Create Target Group

**Settings:**
- Name: `nojira-tg`
- Protocol: HTTP
- Port: 80
- Health check path: `/`
- Register EC2 instance (port 80)

### 3. SSL Certificate

**Option A:** Add to existing wildcard cert
- Go to Certificate Manager
- Add `ops.hushtalent.io` to existing `*.hushtalent.io` cert

**Option B:** Request new certificate
- Certificate Manager → Request certificate
- Domain: `ops.hushtalent.io`
- Validation: DNS (Route 53)

### 4. Route 53 DNS

Create A record:
- Name: `ops.hushtalent.io`
- Type: A - IPv4 address
- Alias: Yes → ALB

### 5. Security Group

Ensure EC2 security group allows:
- Inbound HTTP (80) from ALB security group
- Inbound SSH (22) from your IP

---

## Operations

### View Status

```bash
cd /opt/nojira
docker-compose -f docker-compose.prod.yml ps
```

### View Logs

```bash
# All services
docker-compose -f docker-compose.prod.yml logs -f

# Specific service
docker-compose -f docker-compose.prod.yml logs -f backend
docker-compose -f docker-compose.prod.yml logs -f frontend
docker-compose -f docker-compose.prod.yml logs -f db

# Last 100 lines
docker-compose -f docker-compose.prod.yml logs --tail=100
```

### Restart Services

```bash
# All services
./deploy-ec2.sh restart

# Specific service
docker-compose -f docker-compose.prod.yml restart backend
```

### Stop/Start

```bash
# Stop all
./deploy-ec2.sh stop

# Start all
./deploy-ec2.sh deploy
```

### Update Application

```bash
cd /opt/nojira
git pull origin main
./deploy-ec2.sh update
```

---

## Health Checks

### Test Locally on EC2

```bash
# Backend
curl http://localhost:8007/api/health
# Expected: {"status":"healthy"}

# Frontend
curl http://localhost/
# Expected: HTML content

# Database
docker exec nojira-db psql -U nojira_user -d nojira -c "SELECT 1;"
```

### Test via Domain (after DNS configured)

```bash
curl https://ops.hushtalent.io/api/health
```

---

## Backups

### Automated Backups

After running `./setup-backups.sh`:
- **Schedule:** Daily at 3:00 AM
- **Location:** `/opt/nojira/backups/`
- **Retention:** 7 days
- **Includes:** Database, uploads, environment file

### Manual Backup

```bash
/opt/nojira/backup.sh
```

### Restore Database

```bash
# List backups
ls -lh /opt/nojira/backups/

# Restore specific backup
gunzip -c /opt/nojira/backups/db_20260129_030000.sql.gz | \
  docker exec -i nojira-db psql -U nojira_user -d nojira
```

---

## Monitoring

### Container Monitoring

After running `./setup-monitoring.sh`:
- **Check interval:** Every 5 minutes
- **Auto-restart:** Failed containers automatically restarted
- **Log:** `/opt/nojira/monitor.log`

### View Monitor Log

```bash
tail -f /opt/nojira/monitor.log
```

### Disk Usage

```bash
df -h /opt/nojira
docker system df
```

---

## Troubleshooting

### Container Won't Start

```bash
# Check logs
docker-compose -f docker-compose.prod.yml logs backend

# Check container status
docker-compose -f docker-compose.prod.yml ps

# Restart specific service
docker-compose -f docker-compose.prod.yml restart backend

# Rebuild if code changed
docker-compose -f docker-compose.prod.yml up -d --build backend
```

### Database Connection Issues

```bash
# Check if database is healthy
docker-compose -f docker-compose.prod.yml ps db

# Check database logs
docker-compose -f docker-compose.prod.yml logs db

# Connect to database manually
docker exec -it nojira-db psql -U nojira_user -d nojira
```

### Port Conflicts

```bash
# Check what's using port 80
sudo lsof -i :80

# Check what's using port 8007
sudo lsof -i :8007

# If nginx or other services conflict, stop them:
sudo systemctl stop nginx
```

### Permission Issues

```bash
# Fix permissions on data directories
sudo chown -R ec2-user:ec2-user /opt/nojira/data
sudo chown -R ec2-user:ec2-user /opt/nojira/uploads

# Fix .env permissions
chmod 600 /opt/nojira/.env
```

### View All Container Logs

```bash
# Backend errors
docker logs nojira-backend --tail=100

# Database errors
docker logs nojira-db --tail=100

# Frontend errors
docker logs nojira-frontend --tail=100
```

---

## Security Features

### Container Security
- Non-root users in containers
- Minimal base images (alpine)
- No privileged containers
- Health checks on all services

### Network Security
- Internal Docker network for container communication
- Backend and DB only exposed to localhost (127.0.0.1)
- Frontend exposed on port 80 (via ALB only)
- Security headers in nginx (X-Frame-Options, X-XSS-Protection, etc.)

### Application Security
- JWT authentication (7-day expiration)
- Secure SECRET_KEY (64 characters, auto-generated)
- Strong DB password (32 characters, auto-generated)
- CORS restricted to ops.hushtalent.io
- Environment variables in .env (chmod 600)

### Data Security
- Automated daily backups at 3 AM
- 7-day retention policy
- Persistent volumes for data
- Database and uploads backed up

### Infrastructure Security
- HTTPS via ALB
- EC2 security group restricts port 80 to ALB
- SSH key-based authentication
- Docker socket not exposed

---

## File Structure

```
/opt/nojira/
├── backend/
│   ├── app/
│   ├── alembic/
│   ├── requirements.txt
│   └── Dockerfile
├── frontend/
│   ├── src/
│   ├── package.json
│   ├── nginx.conf
│   └── Dockerfile
├── data/
│   └── postgres/          # Database data
├── uploads/               # File attachments
├── backups/              # Automated backups
│   ├── db_*.sql.gz
│   ├── uploads_*.tar.gz
│   └── backup.log
├── docker-compose.prod.yml
├── .env                  # Environment variables
├── deploy-ec2.sh         # Main deployment script
├── setup-backups.sh      # Backup automation
├── setup-monitoring.sh   # Container monitoring
├── setup-systemd.sh      # Auto-start on reboot
├── backup.sh             # Generated by setup-backups.sh
└── monitor.sh            # Generated by setup-monitoring.sh
```

---

## Deployment Commands Reference

```bash
# Initial deployment
./deploy-ec2.sh deploy

# Restart services
./deploy-ec2.sh restart

# Stop all services
./deploy-ec2.sh stop

# View logs
./deploy-ec2.sh logs

# Check status
./deploy-ec2.sh status

# Update and redeploy
./deploy-ec2.sh update

# Setup automation
./setup-backups.sh
./setup-monitoring.sh
./setup-systemd.sh
```

---

## Post-Deployment Checklist

### ✅ Docker Deployment
- [ ] All 3 containers running (frontend, backend, db)
- [ ] Backend health check passing
- [ ] Frontend serving content
- [ ] Database accepting connections

### ✅ AWS Configuration
- [ ] ALB listener rule created for ops.hushtalent.io
- [ ] Target group created and healthy
- [ ] SSL certificate configured
- [ ] Route 53 DNS record created
- [ ] Security group allows HTTP from ALB

### ✅ Automation
- [ ] Backups enabled (daily at 3 AM)
- [ ] Monitoring enabled (every 5 min)
- [ ] Auto-start on reboot enabled (systemd)

### ✅ Testing
- [ ] Can access https://ops.hushtalent.io
- [ ] Can register new user
- [ ] Can login
- [ ] Can create project/task
- [ ] Can upload file
- [ ] SSL certificate valid

---

## Support

For issues or questions:
1. Check logs: `docker-compose -f docker-compose.prod.yml logs -f`
2. Check status: `docker-compose -f docker-compose.prod.yml ps`
3. Check monitor log: `tail -f /opt/nojira/monitor.log`
4. Review this deployment guide

Common commands:
```bash
# Full restart
./deploy-ec2.sh restart

# View all logs
docker-compose -f docker-compose.prod.yml logs --tail=100

# Check what's running
docker ps

# Connect to database
docker exec -it nojira-db psql -U nojira_user -d nojira
```
